<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" /> 
    <title>WebRTC Data Channel Echo Server Example</title>
</head>
<body>
	<input type="button" value="Start SDP" id="setready" >
	<p id="offer"></p>
    <script type="module">
        let NUM_PACKETS = 100000;
        let SEND_INTERVAL = 500;
		var sdp = "";
        let peer = new RTCPeerConnection();

        let channel = peer.createDataChannel("data", {
            ordered: false,
            maxRetransmits: 0
        });
        channel.binaryType = "arraybuffer";

        channel.onerror = function(evt) {
            console.log("data channel error:", evt);
        };

        let send_times = {};
        channel.onopen = function() {
            console.log("data channel open");

            let packet_number = 0
            let cancel = setInterval(function() {
                if (packet_number == NUM_PACKETS || channel.readyState == "closed") {
                    clearInterval(cancel);
                } else {
					console.log("sending packet", packet_number);
                    let array = new TextEncoder().encode('PACKET SEND FROM BROWSER '+packet_number);
					// const buffer = crypto.getRandomValues(new Uint8Array(1160));
                    channel.send(array);
                    send_times[packet_number] = Date.now();
                    packet_number++
                }
            }, 50);

            channel.onmessage = function(evt) {
                let array = new Uint8Array(evt.data);
				// let text = new TextDecoder().decode(array);
				console.log(`Got this from server`, array.byteLength);
            };
        };
		channel.onclose = function() {
			console.log("data channel closed");
		};

        peer.onicecandidate = function(evt) {
            if (evt.candidate) {
                console.log("received ice candidate", evt.candidate);
            } else {
                console.log("all local candidates received");
            }
        };
		const setready = document.getElementById("setready");
		setready.addEventListener("click", async function(){
			const offer = await peer.createOffer().then(function(offer) {
            	peer.setLocalDescription(offer);
				return offer.sdp;
        	})
			console.log(offer)
			document.getElementById("setready").remove();
			//add the offer to the page
			document.getElementById("offer").innerHTML = sdp;

			var input = document.createElement("input");
			input.type = "text";
			input.id = "sdp";
			document.body.appendChild(input);
			//Add a Send input to send the sdp
			var send = document.createElement("input");
			send.type = "button";
			send.value = "Send";
			send.onclick = function() {
				sdp = JSON.parse(document.getElementById("sdp").value);
				peer.setRemoteDescription(new RTCSessionDescription(sdp.answer)).then(async function() {
					// const answer = await(await peer.createAnswer());
					// console.log(answer)
					var candidate = new RTCIceCandidate(sdp.candidate);
					peer.addIceCandidate(candidate).then(function() {
						console.log("add ice candidate success");
					}).catch(function(err) {
						console.log("error during 'addIceCandidate':", err);
					});
				}).catch(function(e) {
					console.log("error during 'setRemoteDescription':", e);
				});
			};
			document.body.appendChild(send);
		})

		
    </script>
</body>
</html>
